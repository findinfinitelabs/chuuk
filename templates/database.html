{% extends "base.html" %}

{% block title %}Database Viewer - Chuuk Dictionary OCR{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    .tabs {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 20px;
    }
    
    .tab {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1em;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    
    .tab.active {
        border-bottom-color: #3498db;
        color: #3498db;
        font-weight: bold;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .entry-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
        transition: box-shadow 0.3s;
    }
    
    .entry-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .entry-word-pair {
        font-size: 1.1em;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .entry-confidence {
        background: #e8f5e8;
        color: #27ae60;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }
    
    .entry-meta {
        font-size: 0.85em;
        color: #666;
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }
    
    .entry-meta span {
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
    }
    
    .search-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
    }
    
    .search-controls input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 20px;
    }
    
    .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }
    
    .pagination button.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .page-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .page-title {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .entries-count {
        background: #3498db;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä Database Viewer</h2>
    <p>View processed documents and dictionary entries</p>
    
    {% if stats.error %}
    <div class="error">
        <strong>Database Error:</strong> {{ stats.error }}
    </div>
    {% else %}
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_entries or 0 }}</div>
            <div class="stat-label">Dictionary Entries</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_pages or 0 }}</div>
            <div class="stat-label">Pages Processed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.publications or 0 }}</div>
            <div class="stat-label">Publications</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.database_status|title }}</div>
            <div class="stat-label">Database Status</div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('entries')">üìù Dictionary Entries</button>
        <button class="tab" onclick="switchTab('pages')">üìÑ Processed Pages</button>
        <button class="tab" onclick="switchTab('search')">üîç Advanced Search</button>
    </div>
    
    <!-- Dictionary Entries Tab -->
    <div id="entriesTab" class="tab-content active">
        <div class="search-controls">
            <input type="text" id="entrySearch" placeholder="Search entries..." onkeyup="searchEntries()" />
            <button onclick="loadEntries(1)" class="btn">Refresh</button>
            <select id="perPageSelect" onchange="loadEntries(1)">
                <option value="25">25 per page</option>
                <option value="50" selected>50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
        
        <div id="entriesContent">
            <div class="loading">Loading dictionary entries...</div>
        </div>
        
        <div id="entriesPagination" class="pagination" style="display: none;"></div>
    </div>
    
    <!-- Processed Pages Tab -->
    <div id="pagesTab" class="tab-content">
        <h3>üìÑ Recently Processed Pages</h3>
        {% if pages_summary %}
            {% for page in pages_summary %}
            <div class="page-item">
                <div class="page-header">
                    <div class="page-title">{{ page.filename }}</div>
                    <div class="entries-count">{{ page.entries_extracted }} entries</div>
                </div>
                <div class="entry-meta">
                    <span><strong>Publication:</strong> {{ page.publication_id }}</span>
                    <span><strong>Page:</strong> {{ page.page_number or 1 }}</span>
                    <span><strong>Processed:</strong> {{ page.processed_date[:19] | replace('T', ' ') }}</span>
                </div>
                {% if page.ocr_text %}
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: #3498db;">View OCR Text</summary>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">{{ page.ocr_text[:500] }}{% if page.ocr_text|length > 500 %}...{% endif %}</pre>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p style="color: #666; text-align: center; padding: 40px;">No pages have been processed yet.</p>
        {% endif %}
    </div>
    
    <!-- Advanced Search Tab -->
    <div id="searchTab" class="tab-content">
        <h3>üîç Advanced Search</h3>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Search Term:</label>
                <input type="text" id="advancedSearch" placeholder="Enter Chuukese or English word..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Confidence Level:</label>
                    <select id="confidenceFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Any confidence</option>
                        <option value="high">High (80%+)</option>
                        <option value="medium">Medium (60-80%)</option>
                        <option value="low">Low (<60%)</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Source File:</label>
                    <input type="text" id="sourceFilter" placeholder="Filename filter..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                </div>
            </div>
            <button onclick="performAdvancedSearch()" class="btn btn-success">üîç Search</button>
        </div>
        
        <div id="advancedSearchResults" style="margin-top: 20px;"></div>
    </div>
    
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentData = null;
    
    // Load entries on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadEntries(1);
    });
    
    function switchTab(tabName) {
        // Remove active from all tabs and contents
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active to selected tab and content
        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
    }
    
    function loadEntries(page) {
        currentPage = page;
        const perPage = document.getElementById('perPageSelect').value;
        const search = document.getElementById('entrySearch').value;
        
        document.getElementById('entriesContent').innerHTML = '<div class="loading">Loading entries...</div>';
        
        fetch(`/api/database/entries?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('entriesContent').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                currentData = data;
                displayEntries(data.entries);
                updatePagination(data);
            })
            .catch(error => {
                document.getElementById('entriesContent').innerHTML = `<div class="error">Failed to load entries: ${error}</div>`;
            });
    }
    
    function displayEntries(entries) {
        const container = document.getElementById('entriesContent');
        
        if (entries.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No entries found.</p>';
            return;
        }
        
        const html = entries.map(entry => `
            <div class="entry-item">
                <div class="entry-header">
                    <div class="entry-word-pair">
                        <span style="color: #3498db;">${entry.chuukese_word}</span> 
                        ‚Üí 
                        <span style="color: #27ae60;">${entry.english_translation}</span>
                    </div>
                    ${entry.confidence ? `<div class="entry-confidence">${Math.round(entry.confidence * 100)}%</div>` : ''}
                </div>
                
                ${entry.definition && entry.definition !== entry.english_translation ? 
                    `<div style="margin-bottom: 8px;"><strong>Definition:</strong> ${entry.definition}</div>` : ''}
                
                ${entry.examples && entry.examples.length > 0 ? 
                    `<div style="margin-bottom: 8px;"><strong>Examples:</strong> ${entry.examples.join(', ')}</div>` : ''}
                
                <div class="entry-meta">
                    <span><strong>Source:</strong> ${entry.filename || 'Unknown'}</span>
                    ${entry.page_number ? `<span><strong>Page:</strong> ${entry.page_number}</span>` : ''}
                    ${entry.line_number ? `<span><strong>Line:</strong> ${entry.line_number}</span>` : ''}
                    ${entry.created_date ? `<span><strong>Added:</strong> ${new Date(entry.created_date).toLocaleDateString()}</span>` : ''}
                </div>
                
                ${entry.raw_line ? 
                    `<details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #666; font-size: 0.9em;">Show original text</summary>
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 5px; font-family: monospace; font-size: 0.85em;">
                            "${entry.raw_line}"
                        </div>
                    </details>` : ''}
            </div>
        `).join('');
        
        container.innerHTML = html;
    }
    
    function updatePagination(data) {
        const container = document.getElementById('entriesPagination');
        
        if (data.total_pages <= 1) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        
        let html = '';
        
        // Previous button
        html += `<button ${data.page === 1 ? 'disabled' : ''} onclick="loadEntries(${data.page - 1})">‚Äπ Previous</button>`;
        
        // Page numbers
        const start = Math.max(1, data.page - 2);
        const end = Math.min(data.total_pages, data.page + 2);
        
        if (start > 1) {
            html += `<button onclick="loadEntries(1)">1</button>`;
            if (start > 2) html += `<button disabled>...</button>`;
        }
        
        for (let i = start; i <= end; i++) {
            html += `<button class="${i === data.page ? 'active' : ''}" onclick="loadEntries(${i})">${i}</button>`;
        }
        
        if (end < data.total_pages) {
            if (end < data.total_pages - 1) html += `<button disabled>...</button>`;
            html += `<button onclick="loadEntries(${data.total_pages})">${data.total_pages}</button>`;
        }
        
        // Next button
        html += `<button ${data.page === data.total_pages ? 'disabled' : ''} onclick="loadEntries(${data.page + 1})">Next ‚Ä∫</button>`;
        
        container.innerHTML = html;
    }
    
    function searchEntries() {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
            loadEntries(1);
        }, 500);
    }
    
    function performAdvancedSearch() {
        const searchTerm = document.getElementById('advancedSearch').value;
        const confidence = document.getElementById('confidenceFilter').value;
        const source = document.getElementById('sourceFilter').value;
        
        // For now, use the basic search with the search term
        // In a full implementation, you'd create a more sophisticated API endpoint
        document.getElementById('entrySearch').value = searchTerm;
        loadEntries(1);
        
        // Switch to entries tab to show results
        document.querySelector('.tab.active').classList.remove('active');
        document.querySelector('.tab-content.active').classList.remove('active');
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('entriesTab').classList.add('active');
    }
</script>
{% endblock %}
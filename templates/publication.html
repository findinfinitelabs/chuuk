{% extends "base.html" %}

{% block title %}{{ publication.title }} - Chuuk AI Dictionary{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-2">{{ publication.title }}</h2>
            {% if publication.description %}
            <p class="text-muted mb-2">{{ publication.description }}</p>
            {% endif %}
            <p class="text-secondary small mb-0">
                Created: {{ publication.created_at[:10] }} | Pages: {{ publication.pages|length }}
            </p>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Back to Home</a>
    </div>
</div>

<div class="card">
    <h3>Upload Pages</h3>
    <p>Upload dictionary pages (PNG, JPG, PDF, etc.). You can upload multiple pages at once.</p>
    
    <form id="uploadForm" enctype="multipart/form-data" class="mt-4">
        <div class="upload-area" id="uploadArea">
            <p class="h5 mb-3">üìÑ Click or drag files here to upload</p>
            <input type="file" id="fileInput" name="file" accept=".png,.jpg,.jpeg,.gif,.bmp,.tiff,.pdf,.docx" multiple class="d-none">
            <p class="text-muted small">Supported formats: PNG, JPG, PDF, DOCX</p>
        </div>
        
        <div class="mt-4">
            <div class="form-check">
                <input type="checkbox" id="processOcr" name="process_ocr" class="form-check-input" checked>
                <label class="form-check-label" for="processOcr">
                    Process AI recognition automatically after upload
                </label>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="form-check">
                <input type="checkbox" id="indexDictionary" name="index_dictionary" class="form-check-input">
                <label class="form-check-label" for="indexDictionary">
                    Index as dictionary content (extract word translations)
                </label>
            </div>
        </div>
        
        <div class="form-group mt-4">
            <label for="ocrLang" class="form-label">AI Recognition Language</label>
            <select id="ocrLang" name="ocr_lang" class="form-select">
                <option value="eng">English</option>
                <option value="chk" selected>Chuukese (if available)</option>
                <option value="eng+chk">English + Chuukese</option>
            </select>
        </div>
    </form>
    
    <div id="uploadStatus" class="mt-3 alert d-none"></div>
    
    <!-- Processing Logs Container -->
    <div id="processingLogs" class="mt-4 d-none">
        <h4 class="mb-3">üìä Processing Progress</h4>
        <div class="progress mb-3" style="height: 20px;">
            <div id="progressFill" class="progress-bar bg-success" style="width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="processingStatus" class="mb-2 fw-bold"></div>
        <div id="processingStats" class="mb-3 d-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;"></div>
        <div id="logContainer" class="bg-light border rounded p-3" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85em;">
            <div id="logEntries"></div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 30px;">
    <h3>Upload CSV Dictionary</h3>
    <p>Upload a tab-delimited CSV file with Chuukese dictionary entries. The file should have headers: Entry #, Pseudo-Page, Chuukese Word / Form, Part of Speech, English Definition, Examples, Notes</p>
    
    <form id="csvUploadForm" enctype="multipart/form-data" class="mt-4">
        <div class="upload-area" id="csvUploadArea" style="border-color: #28a745; background: linear-gradient(135deg, #f8fff8 0%, #f0f9f0 100%);">
            <p class="h5 mb-3 text-success">üìä Click or drag CSV file here</p>
            <input type="file" id="csvFileInput" name="file" accept=".csv" class="d-none">
            <p class="text-muted small">Supported format: CSV (tab-delimited)</p>
            <div class="mt-3 small text-success fw-bold">
                ‚úì Direct database import - no AI recognition processing needed
            </div>
        </div>
    </form>
    
    <div id="csvUploadStatus" class="mt-3 alert d-none"></div>
</div>

{% if publication.pages %}
<div class="card">
    <h3>Uploaded Pages ({{ publication.pages|length }})</h3>
    
    <div class="page-grid">
        {% for page in publication.pages %}
        <div class="page-item card">
            <img src="{{ url_for('static', filename='placeholder.png') }}" alt="{{ page.filename }}" class="card-img-top" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22%3E%3Crect width=%22200%22 height=%22150%22 fill=%22%23ddd%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E';">
            <div class="card-body">
                <p class="card-title mb-2 fw-bold text-dark small" style="word-break: break-all;">{{ page.filename }}</p>
                <p class="card-text text-secondary small mb-3">{{ page.added_at[:10] }}</p>
                {% if page.ocr_results %}
                <details class="mt-3">
                    <summary class="btn btn-outline-primary btn-sm w-100 text-start">
                        üìÑ View OCR Results
                    </summary>
                    <div class="ocr-result mt-3">
                        {% if page.ocr_results.tesseract %}
                        <strong class="text-primary">Tesseract AI Recognition:</strong>
                        <pre class="mt-2">{{ page.ocr_results.tesseract[:300] }}{% if page.ocr_results.tesseract|length > 300 %}...{% endif %}</pre>
                        {% endif %}
                        
                        {% if page.ocr_results.google_vision %}
                        <strong class="text-success mt-3 d-block">Google Vision AI Recognition:</strong>
                        <pre class="mt-2">{{ page.ocr_results.google_vision[:300] }}{% if page.ocr_results.google_vision|length > 300 %}...{% endif %}</pre>
                        {% endif %}
                        
                        {% if page.type == 'csv' %}
                        <strong class="text-success mt-3 d-block">üìä CSV Upload Info:</strong>
                        <p class="mt-2 text-success">{{ page.entries_added }} dictionary entries added to database</p>
                        {% endif %}
                    </div>
                </details>
                {% else %}
                <button class="btn btn-outline-primary btn-sm w-100 mt-3" onclick="processPageOcr('{{ page.filename }}')">üîç Process OCR</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const processingLogs = document.getElementById('processingLogs');
    const logEntries = document.getElementById('logEntries');
    const progressBar = document.getElementById('progressFill');
    const processingStatus = document.getElementById('processingStatus');
    const processingStats = document.getElementById('processingStats');
    const pubId = '{{ publication.id }}';
    
    let currentSessionId = null;
    let logUpdateInterval = null;
    
    // Click to upload
    uploadArea.addEventListener('click', () => fileInput.click());
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        uploadFiles();
    });
    
    // File selection
    fileInput.addEventListener('change', uploadFiles);
    
    function uploadFiles() {
        const files = fileInput.files;
        if (files.length === 0) return;
        
        uploadStatus.style.display = 'block';
        uploadStatus.innerHTML = '<p style="color: #3498db;">Uploading ' + files.length + ' file(s)...</p>';
        
        const processOcr = document.getElementById('processOcr').checked;
        const indexDictionary = document.getElementById('indexDictionary').checked;
        const ocrLang = document.getElementById('ocrLang').value;
        
        let completed = 0;
        let errors = 0;
        
        Array.from(files).forEach(file => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('process_ocr', processOcr);
            formData.append('index_dictionary', indexDictionary);
            formData.append('ocr_lang', ocrLang);
            
            fetch(`/publication/${pubId}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                completed++;
                if (data.error) errors++;
                
                // Start real-time logging if OCR processing and session ID provided
                if (data.session_id && processOcr) {
                    startProcessingMonitor(data.session_id, file.name);
                }
                
                if (completed === files.length) {
                    if (errors === 0) {
                        uploadStatus.innerHTML = '<p style="color: #27ae60;">‚úì Successfully uploaded ' + files.length + ' file(s)!</p>';
                        if (!processOcr) {
                            setTimeout(() => location.reload(), 1500);
                        }
                    } else {
                        uploadStatus.innerHTML = '<p style="color: #e74c3c;">Uploaded ' + (files.length - errors) + ' file(s), ' + errors + ' failed.</p>';
                    }
                }
            })
            .catch(error => {
                completed++;
                errors++;
                if (completed === files.length) {
                    uploadStatus.innerHTML = '<p style="color: #e74c3c;">Error uploading files. Please try again.</p>';
                }
            });
        });
    }
    
    function startProcessingMonitor(sessionId, filename) {
        currentSessionId = sessionId;
        processingLogs.style.display = 'block';
        
        // Clear previous logs
        logEntries.innerHTML = '';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        processingStatus.textContent = `Processing ${filename}...`;
        
        // Start polling for updates
        logUpdateInterval = setInterval(() => updateProcessingLogs(sessionId), 1000);
        
        // Also get initial logs immediately
        updateProcessingLogs(sessionId);
    }
    
    function updateProcessingLogs(sessionId) {
        // Get current status
        fetch(`/api/processing/status/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                // Update progress bar
                const progress = data.progress_percentage || 0;
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
                
                // Update status
                const status = data.status || 'processing';
                const statusEmoji = {
                    'started': 'üöÄ',
                    'processing': '‚öôÔ∏è',
                    'completed': '‚úÖ',
                    'failed': '‚ùå'
                };
                processingStatus.innerHTML = `${statusEmoji[status] || '‚öôÔ∏è'} Status: ${status.toUpperCase()}`;
                
                // Update stats
                const stats = data.stats || {};
                processingStats.innerHTML = `
                    <div style="background: #e3f2fd; padding: 8px; border-radius: 4px;">
                        <strong>Pages:</strong> ${data.current_page || 0}/${data.total_pages || 1}
                    </div>
                    <div style="background: #f3e5f5; padding: 8px; border-radius: 4px;">
                        <strong>OCR Method:</strong> ${stats.ocr_method || 'Unknown'}
                    </div>
                    <div style="background: #e8f5e8; padding: 8px; border-radius: 4px;">
                        <strong>Words Indexed:</strong> ${stats.words_indexed || 0}
                    </div>
                    <div style="background: ${stats.errors > 0 ? '#ffebee' : '#f1f8e9'}; padding: 8px; border-radius: 4px;">
                        <strong>Errors:</strong> ${stats.errors || 0}
                    </div>
                `;
                
                // Stop polling if completed or failed
                if (status === 'completed' || status === 'failed') {
                    clearInterval(logUpdateInterval);
                    if (status === 'completed') {
                        setTimeout(() => location.reload(), 3000);
                    }
                }
            })
            .catch(error => console.log('Status update error:', error));
        
        // Get recent logs
        fetch(`/api/processing/logs/${sessionId}/recent?limit=50`)
            .then(response => response.json())
            .then(data => {
                if (data.logs) {
                    updateLogDisplay(data.logs);
                }
            })
            .catch(error => console.log('Log update error:', error));
    }
    
    function updateLogDisplay(logs) {
        const logContainer = document.getElementById('logEntries');
        
        // Clear and rebuild log display
        logContainer.innerHTML = '';
        
        logs.forEach(log => {
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            logEntry.style.padding = '5px';
            logEntry.style.borderRadius = '3px';
            
            // Color code by level
            const colors = {
                'info': '#d4edda',
                'warning': '#fff3cd', 
                'error': '#f8d7da',
                'success': '#d1ecf1'
            };
            logEntry.style.backgroundColor = colors[log.level] || colors['info'];
            
            // Format timestamp
            const time = new Date(log.timestamp).toLocaleTimeString();
            
            // Add emoji based on content
            let emoji = '';
            if (log.message.includes('‚úì') || log.message.includes('Completed')) emoji = '‚úÖ';
            else if (log.message.includes('‚ö†') || log.level === 'warning') emoji = '‚ö†Ô∏è';
            else if (log.message.includes('‚úó') || log.level === 'error') emoji = '‚ùå';
            else if (log.message.includes('Starting')) emoji = 'üöÄ';
            else if (log.message.includes('Processing')) emoji = '‚öôÔ∏è';
            else if (log.message.includes('indexed')) emoji = 'üìù';
            
            logEntry.innerHTML = `
                <span style="color: #666; font-size: 0.8em;">[${time}]</span>
                ${emoji} <span>${log.message}</span>
            `;
            
            logContainer.appendChild(logEntry);
        });
        
        // Scroll to bottom
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function processPageOcr(filename) {
        const formData = new FormData();
        formData.append('pub_id', pubId);
        formData.append('filename', filename);
        formData.append('lang', document.getElementById('ocrLang').value);
        
        fetch('/ocr/process', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error processing OCR: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error processing OCR: ' + error);
        });
    }
</script>

<script>
    // CSV Upload functionality
    const csvUploadArea = document.getElementById('csvUploadArea');
    const csvFileInput = document.getElementById('csvFileInput');
    const csvUploadForm = document.getElementById('csvUploadForm');
    const csvUploadStatus = document.getElementById('csvUploadStatus');
    
    // Click to upload CSV
    csvUploadArea.addEventListener('click', () => csvFileInput.click());
    
    // Drag and drop for CSV
    csvUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        csvUploadArea.classList.add('dragover');
    });
    
    csvUploadArea.addEventListener('dragleave', () => {
        csvUploadArea.classList.remove('dragover');
    });
    
    csvUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        csvUploadArea.classList.remove('dragover');
        csvFileInput.files = e.dataTransfer.files;
        uploadCsvFile();
    });
    
    // File selection for CSV
    csvFileInput.addEventListener('change', uploadCsvFile);
    
    function uploadCsvFile() {
        const files = csvFileInput.files;
        if (files.length === 0) return;
        
        if (files.length > 1) {
            csvUploadStatus.style.display = 'block';
            csvUploadStatus.innerHTML = '<p style="color: #e74c3c;">Please select only one CSV file at a time.</p>';
            return;
        }
        
        const file = files[0];
        if (!file.name.toLowerCase().endsWith('.csv')) {
            csvUploadStatus.style.display = 'block';
            csvUploadStatus.innerHTML = '<p style="color: #e74c3c;">Please select a CSV file.</p>';
            return;
        }
        
        csvUploadStatus.style.display = 'block';
        csvUploadStatus.innerHTML = '<p style="color: #3498db;">Uploading and processing CSV...</p>';
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch(`/publication/${pubId}/upload_csv`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                csvUploadStatus.innerHTML = `<p style="color: #27ae60;">‚úì Successfully processed CSV: ${data.entries_added} entries added to database!</p>`;
                setTimeout(() => location.reload(), 2000);
            } else {
                csvUploadStatus.innerHTML = '<p style="color: #e74c3c;">Error: ' + (data.error || 'Unknown error occurred') + '</p>';
            }
        })
        .catch(error => {
            csvUploadStatus.innerHTML = '<p style="color: #e74c3c;">Error uploading CSV. Please try again.</p>';
        });
    }
</script>

{% endblock %}
